<!-- HTML header for doxygen 1.10.0-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Control Surface: Pin-Change-Interrupt-Encoders.ino</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../clipboard.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
window.MathJax = {
  options: {
    ignoreHtmlClass: 'tex2jax_ignore',
    processHtmlClass: 'tex2jax_process'
  }
};
</script>
<script type="text/javascript" id="MathJax-script" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
<script type="text/javascript" src="../../darkmode_toggle.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300&family=Roboto:wght@400&family=Roboto:wght@500&display=swap" rel="stylesheet">
<link href="../../custom_stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Control Surface<span id="projectnumber">&#160;<code><a href="/Control-Surface/">main</a></code></span>
   </div>
   <div id="projectbrief">MIDI Control Surface library for Arduino</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">Pin-Change-Interrupt-Encoders.ino</div></div>
</div><!--header-->
<div class="contents">
<h1><a class="anchor" id="pin-change-interrupt-encoders"></a>
Pin-Change-Interrupt-Encoders</h1>
<p>This example reads multiple encoders using pin change interrupts, on an Arduino Uno or Nano.</p>
<dl class="section user"><dt>Boards: <b class="boards-info" title="Control Surface&apos;s automated continuous integration workflows regularly verify that this example compiles successfully for the following boards. The list is not exhaustive, and the example will most likely work on other boards as well (perhaps requiring slight modifications).">ðŸ›ˆ</b> </dt><dd>AVR</dd></dl>
<p>The ATmega328P microcontroller only has two interrupt pins (2 and 3), so if you want to use more than two interrupt-driven encoders, you'll either have to use a timer interrupt to continuously poll the encoders, or use the chip's pin change interrupts. This example demonstrates the latter.</p>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="../../da/dda/Timer-Interrupt-Encoders_8ino-example.html">Timer-Interrupt-Encoders.ino</a></dd></dl>
<p>Familiarity with <a href="https://www.arduino.cc/en/Reference/PortManipulation">direct port manipulation</a> is assumed.</p>
<h2><a class="anchor" id="connections-49"></a>
Connections</h2>
<p>Connect three encoders to the pins of port C as follows:</p>
<ul>
<li>A0: pin A of encoder #0</li>
<li>A1: pin B of encoder #0</li>
<li>A2: pin A of encoder #1</li>
<li>A3: pin B of encoder #1</li>
<li>A4: pin A of encoder #2</li>
<li>A5: pin B of encoder #2</li>
</ul>
<p>Connect the common pins to ground, the internal pull-up resistors will be enabled.</p>
<h2><a class="anchor" id="behavior-50"></a>
Behavior</h2>
<p>When the position of one of the encoders changes, it is printed to the Serial monitor.</p>
<p>Written by PieterP, 2021-08-11 <br  />
 <a href="https://github.com/tttapa/Arduino-Helpers">https://github.com/tttapa/Arduino-Helpers</a></p>
<div class="fragment"><div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../dc/de6/Arduino__Helpers_8h.html">Arduino_Helpers.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../dd/ddf/RegisterEncoders_8hpp.html">AH/Hardware/RegisterEncoders.hpp</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// The number of encoders to read:</span></div>
<div class="line"><span class="keyword">constexpr</span> <a class="code hl_function" href="../../da/de8/group__AH__Containers.html#ga6ee13d5c260727ac6a7de2ee21cc76f9">uint8_t</a> <a class="code hl_function" href="../../da/de8/group__AH__Containers.html#ga6ee13d5c260727ac6a7de2ee21cc76f9">num_enc</a> = 3;</div>
<div class="line"><span class="comment">// Mask the bottom 6 bits of the GPIO registers (2 pins Ã— 3 encoders).</span></div>
<div class="line"><span class="comment">// This determines which pins are used:</span></div>
<div class="line"><span class="keyword">const</span> <a class="code hl_function" href="../../da/de8/group__AH__Containers.html#ga6ee13d5c260727ac6a7de2ee21cc76f9">uint8_t</a> <a class="code hl_function" href="../../da/de8/group__AH__Containers.html#ga6ee13d5c260727ac6a7de2ee21cc76f9">pin_mask</a> = 0x3F;</div>
<div class="line"><span class="comment">// The actual encoder object that keeps track of the encoder state:</span></div>
<div class="line"><a class="code hl_class" href="../../d2/d7b/classAH_1_1RegisterEncoders.html">RegisterEncoders&lt;uint8_t, num_enc, int32_t, true&gt;</a> <a class="code hl_function" href="../../da/de8/group__AH__Containers.html#ga6ee13d5c260727ac6a7de2ee21cc76f9">encoders</a>;</div>
<div class="line"><span class="comment">// AVR uses 8-bit GPIO registers, so the register type is uint8_t.</span></div>
<div class="line"><span class="comment">// Then we specify the number of encoders, the position type,</span></div>
<div class="line"><span class="comment">// and whether the encoders should be interrupt-safe: since we&#39;ll</span></div>
<div class="line"><span class="comment">// be calling `encoders.update()` in an interrupt handler, it is </span></div>
<div class="line"><span class="comment">// important that this is set to true.</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Pin change interrupt handler that reads the pins and updates the state:</span></div>
<div class="line"><a class="code hl_function" href="../../da/de8/group__AH__Containers.html#ga6ee13d5c260727ac6a7de2ee21cc76f9">ISR</a> (<a class="code hl_function" href="../../da/de8/group__AH__Containers.html#ga6ee13d5c260727ac6a7de2ee21cc76f9">PCINT1_vect</a>) { <a class="code hl_function" href="../../da/de8/group__AH__Containers.html#ga6ee13d5c260727ac6a7de2ee21cc76f9">encoders</a>.<a id="a0" name="a0"></a><a class="code hl_function" href="../../d2/d7b/classAH_1_1RegisterEncoders.html#ab1cc15c13e950f83a66ae7baa920f76a">update</a>(<a class="code hl_function" href="../../da/de8/group__AH__Containers.html#ga6ee13d5c260727ac6a7de2ee21cc76f9">PINC</a> &amp; <a class="code hl_function" href="../../da/de8/group__AH__Containers.html#ga6ee13d5c260727ac6a7de2ee21cc76f9">pin_mask</a>); } <span class="comment">// read port C</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="../../da/de8/group__AH__Containers.html#ga6ee13d5c260727ac6a7de2ee21cc76f9">setup</a>() {</div>
<div class="line">  <a class="code hl_function" href="../../da/de8/group__AH__Containers.html#ga6ee13d5c260727ac6a7de2ee21cc76f9">PCMSK1</a> |= <a class="code hl_function" href="../../da/de8/group__AH__Containers.html#ga6ee13d5c260727ac6a7de2ee21cc76f9">pin_mask</a>; <span class="comment">// enable pin change interrupt for given pins in port C</span></div>
<div class="line">  <a class="code hl_function" href="../../da/de8/group__AH__Containers.html#ga6ee13d5c260727ac6a7de2ee21cc76f9">DDRC</a> &amp;= <a class="code hl_function" href="../../da/de8/group__AH__Containers.html#ga6ee13d5c260727ac6a7de2ee21cc76f9">~pin_mask</a>;  <span class="comment">// input mode for port C</span></div>
<div class="line">  <a class="code hl_function" href="../../da/de8/group__AH__Containers.html#ga6ee13d5c260727ac6a7de2ee21cc76f9">PORTC</a> |= <a class="code hl_function" href="../../da/de8/group__AH__Containers.html#ga6ee13d5c260727ac6a7de2ee21cc76f9">pin_mask</a>;  <span class="comment">// enable pull-up resistors for port C</span></div>
<div class="line">  <a class="code hl_function" href="../../da/de8/group__AH__Containers.html#ga6ee13d5c260727ac6a7de2ee21cc76f9">PCICR</a> |= 1 &lt;&lt; 1;    <span class="comment">// enable pin change interrupt for port C</span></div>
<div class="line">  <a class="code hl_function" href="../../da/de8/group__AH__Containers.html#ga6ee13d5c260727ac6a7de2ee21cc76f9">Serial</a>.begin(115200);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> loop() {</div>
<div class="line">  <span class="comment">// The previous position of each encoder, to detect changes:</span></div>
<div class="line">  <span class="keyword">static</span> <a class="code hl_function" href="../../da/de8/group__AH__Containers.html#ga6ee13d5c260727ac6a7de2ee21cc76f9">int32_t</a> <a class="code hl_function" href="../../da/de8/group__AH__Containers.html#ga6ee13d5c260727ac6a7de2ee21cc76f9">prevPos</a>[<a class="code hl_function" href="../../da/de8/group__AH__Containers.html#ga6ee13d5c260727ac6a7de2ee21cc76f9">num_enc</a>] {};</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Read the encoder positions and print if they changed:</span></div>
<div class="line">  <span class="keywordflow">for</span> (<a class="code hl_function" href="../../da/de8/group__AH__Containers.html#ga6ee13d5c260727ac6a7de2ee21cc76f9">uint8_t</a> <a class="code hl_function" href="../../da/de8/group__AH__Containers.html#ga6ee13d5c260727ac6a7de2ee21cc76f9">i</a> = 0; <a class="code hl_function" href="../../da/de8/group__AH__Containers.html#ga6ee13d5c260727ac6a7de2ee21cc76f9">i</a> &lt; <a class="code hl_function" href="../../da/de8/group__AH__Containers.html#ga6ee13d5c260727ac6a7de2ee21cc76f9">num_enc</a>; ++<a class="code hl_function" href="../../da/de8/group__AH__Containers.html#ga6ee13d5c260727ac6a7de2ee21cc76f9">i</a>) {</div>
<div class="line">    <a class="code hl_function" href="../../da/de8/group__AH__Containers.html#ga6ee13d5c260727ac6a7de2ee21cc76f9">int32_t</a> <a class="code hl_function" href="../../da/de8/group__AH__Containers.html#ga6ee13d5c260727ac6a7de2ee21cc76f9">newPos</a> = <a class="code hl_function" href="../../da/de8/group__AH__Containers.html#ga6ee13d5c260727ac6a7de2ee21cc76f9">encoders</a>[<a class="code hl_function" href="../../da/de8/group__AH__Containers.html#ga6ee13d5c260727ac6a7de2ee21cc76f9">i</a>].read();</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code hl_function" href="../../da/de8/group__AH__Containers.html#ga6ee13d5c260727ac6a7de2ee21cc76f9">newPos</a> != <a class="code hl_function" href="../../da/de8/group__AH__Containers.html#ga6ee13d5c260727ac6a7de2ee21cc76f9">prevPos</a>[<a class="code hl_function" href="../../da/de8/group__AH__Containers.html#ga6ee13d5c260727ac6a7de2ee21cc76f9">i</a>]) {</div>
<div class="line">      <a class="code hl_function" href="../../da/de8/group__AH__Containers.html#ga6ee13d5c260727ac6a7de2ee21cc76f9">Serial</a> &lt;&lt; <span class="charliteral">&#39;[&#39;</span> &lt;&lt; <a class="code hl_function" href="../../da/de8/group__AH__Containers.html#ga6ee13d5c260727ac6a7de2ee21cc76f9">i</a> &lt;&lt; <span class="stringliteral">&quot;] &quot;</span> &lt;&lt; <a class="code hl_function" href="../../da/de8/group__AH__Containers.html#ga6ee13d5c260727ac6a7de2ee21cc76f9">newPos</a> &lt;&lt; <a class="code hl_function" href="../../d8/d4b/group__AH__PrintStream.html#ga439f453f806df7d97e736ff0e7151344">endl</a>;</div>
<div class="line">      <a class="code hl_function" href="../../da/de8/group__AH__Containers.html#ga6ee13d5c260727ac6a7de2ee21cc76f9">prevPos</a>[<a class="code hl_function" href="../../da/de8/group__AH__Containers.html#ga6ee13d5c260727ac6a7de2ee21cc76f9">i</a>] = <a class="code hl_function" href="../../da/de8/group__AH__Containers.html#ga6ee13d5c260727ac6a7de2ee21cc76f9">newPos</a>;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="ttc" id="aArduino__Helpers_8h_html"><div class="ttname"><a href="../../dc/de6/Arduino__Helpers_8h.html">Arduino_Helpers.h</a></div><div class="ttdoc">Dummy header file for Arduino builder.</div></div>
<div class="ttc" id="aRegisterEncoders_8hpp_html"><div class="ttname"><a href="../../dd/ddf/RegisterEncoders_8hpp.html">RegisterEncoders.hpp</a></div></div>
<div class="ttc" id="aclassAH_1_1RegisterEncoders_html"><div class="ttname"><a href="../../d2/d7b/classAH_1_1RegisterEncoders.html">::RegisterEncoders</a></div><div class="ttdoc">Class for keeping track of the position of multiple rotary encoders.</div><div class="ttdef"><b>Definition</b> <a href="../../dd/ddf/RegisterEncoders_8hpp_source.html#l00052">RegisterEncoders.hpp:52</a></div></div>
<div class="ttc" id="aclassAH_1_1RegisterEncoders_html_ab1cc15c13e950f83a66ae7baa920f76a"><div class="ttname"><a href="../../d2/d7b/classAH_1_1RegisterEncoders.html#ab1cc15c13e950f83a66ae7baa920f76a">AH::RegisterEncoders::update</a></div><div class="ttdeci">bool update(RegisterType newstate)</div><div class="ttdoc">Update the encoder positions based on the new state.</div><div class="ttdef"><b>Definition</b> <a href="../../dd/ddf/RegisterEncoders_8hpp_source.html#l00096">RegisterEncoders.hpp:96</a></div></div>
<div class="ttc" id="agroup__AH__Containers_html_ga6ee13d5c260727ac6a7de2ee21cc76f9"><div class="ttname"><a href="../../da/de8/group__AH__Containers.html#ga6ee13d5c260727ac6a7de2ee21cc76f9">AH::copyAs</a></div><div class="ttdeci">Array&lt; T, N &gt; copyAs(const Array&lt; U, N &gt; &amp;src)</div><div class="ttdoc">Copy an Array to an Array of a different type.</div><div class="ttdef"><b>Definition</b> <a href="../../d5/db6/ArrayHelpers_8hpp_source.html#l00105">ArrayHelpers.hpp:105</a></div></div>
<div class="ttc" id="agroup__AH__PrintStream_html_ga439f453f806df7d97e736ff0e7151344"><div class="ttname"><a href="../../d8/d4b/group__AH__PrintStream.html#ga439f453f806df7d97e736ff0e7151344">AH::endl</a></div><div class="ttdeci">Print &amp; endl(Print &amp;printer)</div><div class="ttdef"><b>Definition</b> <a href="../../da/d69/PrintStream_8cpp_source.html#l00028">PrintStream.cpp:28</a></div></div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0
</small></address>
</body>
</html>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Arduino Helpers: MCP23017-Encoders-Interrupts.ino</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/SVG"],
});
</script>
<script type="text/javascript" async="async" src="/MathJax/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../custom_stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Arduino Helpers
   &#160;<span id="projectnumber">1.0.0</span>
   </div>
   <div id="projectbrief">Utility library for Arduino</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">MCP23017-Encoders-Interrupts.ino</div>  </div>
</div><!--header-->
<div class="contents">
<h1><a class="anchor" id="autotoc_md46"></a>
MCP23017-Encoders-Interrupts</h1>
<p>This example demonstrates the use of MCP23017 I²C port expanders with rotary encoders, using hardware interrupts so you don't miss any pulses.</p>
<dl class="section user"><dt>Boards:</dt><dd>Teensy 3.x</dd></dl>
<p>This only works on Teensy boards, and maybe on other ARM boards. <br  />
 I've tested it using a Teensy 3.2 and a Teensy 4.0.</p>
<p>AVR boards (Arduino Uno, Mega, etc.) don't support I²C inside of interrupt service routines, so there's no way to read the state of the MCP23017 inside of an ISR. <br  />
 The same goes for ESP32 and ESP8266, although there may be ways around this by using alternative I²C drivers or by using FreeRTOS features.</p>
<h2><a class="anchor" id="autotoc_md47"></a>
Connections</h2>
<ul>
<li>SDA: MCP23017 SDA</li>
<li>SCL: MCP23017 SCL</li>
<li>12: MCP23017 INTA or INTB</li>
</ul>
<p>Connect up to 8 encoders to the MCP23017's GPIO pins: the first encoder connects to GPIO A0 and A1, the second encoder connects to GPIO A2 and A3, ..., the eighth encoder connects to GPIO B6 and B7. <br  />
 Connect the "common" pins of the encoders to ground. <br  />
 The built-in pull-up resistors of the MCP23017 will be enabled.</p>
<p>Make sure that the reset and address pins are all configured correctly (reset to Vcc; A0, A1 and A2 to ground).</p>
<p>If you need more than one MCP23017 with encoders, you can connect their interrupt pins together. This does result in higher latency, because on average, half of the total number of MCP23017s have to be polled, which is relatively slow, and might lead to missed pulses when using a large number of encoders.</p>
<h2><a class="anchor" id="autotoc_md48"></a>
Behavior</h2>
<p>When the position of one of the encoders changes, it is printed to the Serial monitor.</p>
<p>The interrupt pin of the MCP23017 triggers a hardware interrupt on the Arduino. This means that you don't have to manually poll the encoders all the time.</p>
<p>Written by PieterP, 2020-04-06 <br  />
 <a href="https://github.com/tttapa/Arduino-Helpers">https://github.com/tttapa/Arduino-Helpers</a></p>
<div class="fragment"><div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../dc/de6/Arduino__Helpers_8h.html">Arduino_Helpers.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../d8/dd2/MCP23017Encoders_8hpp.html">AH/Hardware/MCP23017Encoders.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../dd/d80/PrintStream_8hpp.html">AH/PrintStream/PrintStream.hpp</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;Wire.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">using</span> WireType = decltype(Wire);     <span class="comment">// The type of I²C driver to use</span></div>
<div class="line"><span class="keyword">using</span> EncoderPositionType = int32_t; <span class="comment">// The type for saving encoder positions</span></div>
<div class="line">constexpr <span class="keywordtype">bool</span> IntSafe = <span class="keyword">true</span>;       <span class="comment">// Make it safe to call `update` in an ISR</span></div>
<div class="line"><span class="keyword">using</span> MCPEncoderType = <a name="_a0"></a><a class="code" href="../../d5/dd0/classMCP23017Encoders.html">MCP23017Encoders&lt;WireType, EncoderPositionType, IntSafe&gt;</a>;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> uint8_t interrupt_pin = 12;</div>
<div class="line"> </div>
<div class="line">MCPEncoderType enc = {Wire, 0x0, interrupt_pin};</div>
<div class="line"><span class="comment">//                    │     │    └─ Interrupt pin</span></div>
<div class="line"><span class="comment">//                    │     └────── Address offset</span></div>
<div class="line"><span class="comment">//                    └──────────── I²C interface</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> isr() {</div>
<div class="line">  enc.<a name="a1"></a><a class="code" href="../../d5/dd0/classMCP23017Encoders.html#ac5c54df7ed3b930268c8d7752c101725">update</a>(); <span class="comment">// Read the state of the encoders and update the positions</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> setup() {</div>
<div class="line">  Serial.begin(115200);</div>
<div class="line">  Wire.begin(); <span class="comment">// Must be called before enc.begin()</span></div>
<div class="line">  Wire.setClock(800000);</div>
<div class="line">  enc.begin(); <span class="comment">// Initialize the MCP23017</span></div>
<div class="line">  attachInterrupt(digitalPinToInterrupt(interrupt_pin), isr, <a name="a2"></a><a class="code" href="../../dd/ddf/ExtendedInputOutput_8hpp.html#ad294464395ca0655395db09e768fdc1d">LOW</a>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> loop() {</div>
<div class="line">  <span class="comment">// No `enc.update()` here, everything happens inside of the ISR</span></div>
<div class="line">  </div>
<div class="line">  <span class="comment">// Save the previous positions</span></div>
<div class="line">  <span class="keyword">static</span> EncoderPositionType prevPositions[8] = {};</div>
<div class="line">  <span class="comment">// Check if an encoder position changed and print it</span></div>
<div class="line">  <span class="keywordflow">for</span> (uint8_t i = 0; i &lt; 8; ++i) {</div>
<div class="line">    <span class="keyword">auto</span> newPosition = enc.read(i);</div>
<div class="line">    <span class="keywordflow">if</span> (newPosition != prevPositions[i]) {</div>
<div class="line">      Serial &lt;&lt; <span class="charliteral">&#39;[&#39;</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">&quot;] &quot;</span> &lt;&lt; newPosition &lt;&lt; <a name="a3"></a><a class="code" href="../../d8/d4b/group__AH__PrintStream.html#gaae13bd0e8ea7184cf85b86bcd1a01e2d">endl</a>;</div>
<div class="line">      prevPositions[i] = newPosition;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<div class="ttc" id="aExtendedInputOutput_8hpp_html_ad294464395ca0655395db09e768fdc1d"><div class="ttname"><a href="../../dd/ddf/ExtendedInputOutput_8hpp.html#ad294464395ca0655395db09e768fdc1d">LOW</a></div><div class="ttdeci">const PinStatus_t LOW</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/ddf/ExtendedInputOutput_8hpp_source.html#l00057">ExtendedInputOutput.hpp:57</a></div></div>
<div class="ttc" id="aclassMCP23017Encoders_html_ac5c54df7ed3b930268c8d7752c101725"><div class="ttname"><a href="../../d5/dd0/classMCP23017Encoders.html#ac5c54df7ed3b930268c8d7752c101725">MCP23017Encoders::update</a></div><div class="ttdeci">void update()</div><div class="ttdoc">If the state of the MCP23017's GPIO changed, read the new state and update the encoder positions.</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/dd2/MCP23017Encoders_8hpp_source.html#l00209">MCP23017Encoders.hpp:209</a></div></div>
<div class="ttc" id="aMCP23017Encoders_8hpp_html"><div class="ttname"><a href="../../d8/dd2/MCP23017Encoders_8hpp.html">MCP23017Encoders.hpp</a></div></div>
<div class="ttc" id="agroup__AH__PrintStream_html_gaae13bd0e8ea7184cf85b86bcd1a01e2d"><div class="ttname"><a href="../../d8/d4b/group__AH__PrintStream.html#gaae13bd0e8ea7184cf85b86bcd1a01e2d">endl</a></div><div class="ttdeci">Print &amp; endl(Print &amp;printer)</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d69/PrintStream_8cpp_source.html#l00027">PrintStream.cpp:27</a></div></div>
<div class="ttc" id="aPrintStream_8hpp_html"><div class="ttname"><a href="../../dd/d80/PrintStream_8hpp.html">PrintStream.hpp</a></div></div>
<div class="ttc" id="aArduino__Helpers_8h_html"><div class="ttname"><a href="../../dc/de6/Arduino__Helpers_8h.html">Arduino_Helpers.h</a></div><div class="ttdoc">Dummy header file for Arduino builder. You have to add this file first, so the other headers are in t...</div></div>
<div class="ttc" id="aclassMCP23017Encoders_html"><div class="ttname"><a href="../../d5/dd0/classMCP23017Encoders.html">MCP23017Encoders</a></div><div class="ttdoc">Class for reading 8 rotary encoders using a MCP23017 I²C port expander.</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/dd2/MCP23017Encoders_8hpp_source.html#l00058">MCP23017Encoders.hpp:58</a></div></div>
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>

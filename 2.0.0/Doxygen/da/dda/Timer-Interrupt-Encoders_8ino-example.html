<!-- HTML header for doxygen 1.10.0-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Control Surface: Timer-Interrupt-Encoders.ino</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../clipboard.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
window.MathJax = {
  options: {
    ignoreHtmlClass: 'tex2jax_ignore',
    processHtmlClass: 'tex2jax_process'
  }
};
</script>
<script type="text/javascript" id="MathJax-script" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
<script type="text/javascript" src="../../darkmode_toggle.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300&family=Roboto:wght@400&family=Roboto:wght@500&display=swap" rel="stylesheet">
<link href="../../custom_stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Control Surface<span id="projectnumber">&#160;<code><a href="/Control-Surface/">2.0.0</a></code></span>
   </div>
   <div id="projectbrief">MIDI Control Surface library for Arduino</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">Timer-Interrupt-Encoders.ino</div></div>
</div><!--header-->
<div class="contents">
<h1><a class="anchor" id="timer-interrupt-encoders"></a>
Timer-Interrupt-Encoders</h1>
<p>This example reads multiple encoders using a timer interrupt, on an Arduino Uno or Nano.</p>
<dl class="section user"><dt>Boards: <b class="boards-info" title="Control Surface&apos;s automated continuous integration workflows regularly verify that this example compiles successfully for the following boards. The list is not exhaustive, and the example will most likely work on other boards as well (perhaps requiring slight modifications).">ðŸ›ˆ</b> </dt><dd>AVR</dd></dl>
<p>The ATmega328P microcontroller only has two interrupt pins (2 and 3), so if you want to use more than two interrupt-driven encoders, you'll either have to use a timer interrupt to continuously poll the encoders, or use the chip's pin change interrupts. This example demonstrates the former.</p>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="../../d6/dd2/Pin-Change-Interrupt-Encoders_8ino-example.html">Pin-Change-Interrupt-Encoders.ino</a></dd></dl>
<p>Familiarity with <a href="https://www.arduino.cc/en/Reference/PortManipulation">direct port manipulation</a> is assumed.</p>
<h2><a class="anchor" id="connections-34"></a>
Connections</h2>
<p>Connect three encoders to the pins of port C as follows:</p>
<ul>
<li>A0: pin A of encoder #0</li>
<li>A1: pin B of encoder #0</li>
<li>A2: pin A of encoder #1</li>
<li>A3: pin B of encoder #1</li>
<li>A4: pin A of encoder #2</li>
<li>A5: pin B of encoder #2</li>
</ul>
<p>Connect the common pins to ground, the internal pull-up resistors will be enabled.</p>
<h2><a class="anchor" id="behavior-36"></a>
Behavior</h2>
<p>When the position of one of the encoders changes, it is printed to the Serial monitor.</p>
<p>Written by PieterP, 2021-08-11 <br  />
 <a href="https://github.com/tttapa/Arduino-Helpers">https://github.com/tttapa/Arduino-Helpers</a></p>
<div class="fragment"><div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../dc/de6/Arduino__Helpers_8h.html">Arduino_Helpers.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../dd/ddf/RegisterEncoders_8hpp.html">AH/Hardware/RegisterEncoders.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;TimerHelpers.hpp&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// The number of encoders to read:</span></div>
<div class="line"><span class="keyword">constexpr</span> uint8_t num_enc = 3;</div>
<div class="line"><span class="comment">// Mask the bottom 6 bits of the GPIO registers (2 pins Ã— 3 encoders).</span></div>
<div class="line"><span class="comment">// This determines which pins are used:</span></div>
<div class="line"><span class="keyword">const</span> uint8_t pin_mask = 0x3F;</div>
<div class="line"><span class="comment">// The actual encoder object that keeps track of the encoder state:</span></div>
<div class="line">RegisterEncoders&lt;uint8_t, num_enc, int32_t, true&gt; encoders;</div>
<div class="line"><span class="comment">// AVR uses 8-bit GPIO registers, so the register type is uint8_t.</span></div>
<div class="line"><span class="comment">// Then we specify the number of encoders, the position type,</span></div>
<div class="line"><span class="comment">// and whether the encoders should be interrupt-safe: since we&#39;ll</span></div>
<div class="line"><span class="comment">// be calling `encoders.update()` in an interrupt handler, it is </span></div>
<div class="line"><span class="comment">// important that this is set to true.</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Timer interrupt handler that reads the pins and updates the state:</span></div>
<div class="line">ISR (TIMER2_COMPA_vect) { encoders.update(PINC &amp; pin_mask); } <span class="comment">// read port C</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> setup() {</div>
<div class="line">  DDRC &amp;= ~pin_mask; <span class="comment">// input mode for port C</span></div>
<div class="line">  PORTC |= pin_mask; <span class="comment">// enable pull-up resistors for port C</span></div>
<div class="line">  setTimer2Prescaler(Timer2Prescaler::S8);</div>
<div class="line">  setTimer2WGMode(Timer2WGMode::CTC);</div>
<div class="line">  OCR2A = 250 - 1; <span class="comment">// 8 kHz poll rate (if FCPU = 16&#39;000&#39;000)</span></div>
<div class="line">  bitSet(TIMSK2, OCIE2A); <span class="comment">// Timer2 Compare A Match Interrupt Enable</span></div>
<div class="line">  Serial.begin(115200);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> loop() {</div>
<div class="line">  <span class="comment">// The previous position of each encoder, to detect changes:</span></div>
<div class="line">  <span class="keyword">static</span> int32_t prevPos[num_enc] {};</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Read the encoder positions and print if they changed:</span></div>
<div class="line">  <span class="keywordflow">for</span> (uint8_t i = 0; i &lt; num_enc; ++i) {</div>
<div class="line">    int32_t newPos = encoders[i].read();</div>
<div class="line">    <span class="keywordflow">if</span> (newPos != prevPos[i]) {</div>
<div class="line">      Serial &lt;&lt; <span class="charliteral">&#39;[&#39;</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">&quot;] &quot;</span> &lt;&lt; newPos &lt;&lt; endl;</div>
<div class="line">      prevPos[i] = newPos;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="ttc" id="aArduino__Helpers_8h_html"><div class="ttname"><a href="../../dc/de6/Arduino__Helpers_8h.html">Arduino_Helpers.h</a></div><div class="ttdoc">Dummy header file for Arduino builder.</div></div>
<div class="ttc" id="aRegisterEncoders_8hpp_html"><div class="ttname"><a href="../../dd/ddf/RegisterEncoders_8hpp.html">RegisterEncoders.hpp</a></div></div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0
</small></address>
</body>
</html>
